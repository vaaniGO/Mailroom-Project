<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ashoka University Mailroom</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="/assets/css/global-styles.css" rel="stylesheet">
        <link href="/assets/css/package-card.css" rel="stylesheet">
        <link href="/assets/css/view-packages.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    </head>
<body>
    <%-include("partials/navbar.ejs")-%>
  <div class="container">
    <form id="checkout-form" method="POST" action="/checkout">
        <div class="packages-wrapper">
            <div class="student-details">
                <h1>Your Packages</h1>
                <p><%= student.UserName %></p>
                <p><%= student.AshokaId %></p>
            </div>
            <button id="select-all">Select All</button>
      <% packages.forEach(package => { %>
        <%- include('partials/packageCard.ejs', { 
          packageNo: package.packageNo, 
          datestamp: package.timestamp.split(' ')[0].replace(/-/g, '/').slice(0, 5),
          timestamp: package.timestamp, 
          deliveryPartner: package.deliveryPartner,
          ashokaID: package.ashokaId
        }) %>
      <% }) %>
      <button type="submit" id="checkout-btn" onclick="checkout(event);">Checkout</button>
    </div>
    </form>
  </div>

  <script>
    document.getElementById('select-all').addEventListener('click', function() {
      document.querySelectorAll('.package-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
    });
  

    function checkout(event) {
  event.preventDefault();

  const selectedPackages = [];
  const checkboxes = document.querySelectorAll('.package-checkbox:checked');

  checkboxes.forEach(checkbox => {
    const packageData = {
      packageNo: checkbox.dataset.packageNo, // Access data-package-no
      AshokaId: checkbox.dataset.ashokaId,  // Access data-ashoka-id
      timestamp: checkbox.dataset.timestamp // Access data-timestamp
    };
    selectedPackages.push(packageData);
  });

  if (selectedPackages.length === 0) {
    alert('Please select at least one package.');
    return;
  }

  console.log(selectedPackages);

  fetch('/checkout', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ packages: selectedPackages }),
  })
    .then(response => {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error("Network response was not ok");
      }
    })
    .then(html => {
      document.open();
      document.write(html);
      document.close();
    })
    .catch(error => {
      console.error("Error during checkout:", error);
    });
}
  </script>
</body>
</html>
